name: "üîê Secure RDP Setup (Simple Password)"
on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Check Runner IP (Debug)
        run: |
          Write-Host "Initial Public IP:"
          (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
          Write-Host "`nNetwork Configuration:"
          ipconfig

      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable NLA for easier connection
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Configure RDP to use any authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "AllowTSConnections" -Value 1 -Force

      - name: Configure Windows Firewall
        run: |
          # Remove any existing conflicting rules
          netsh advfirewall firewall delete rule name="RDP (TCP-In)" 2>$null
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="Remote Desktop" 2>$null
          
          # Allow RDP in Windows Firewall
          netsh advfirewall firewall add rule `
            name="RDP-Allow-All" `
            dir=in `
            protocol=TCP `
            localport=3389 `
            action=allow `
            remoteip=any
          
          # Also enable via PowerShell
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" 2>$null
          New-NetFirewallRule -DisplayName "RDP Port 3389" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow

      - name: Create RDP User with SIMPLE Password
        run: |
          # Delete existing RDP user if exists (clean start)
          $existingUser = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name "RDP" -Confirm:$false
          }

          # Generate SIMPLE password - ONLY letters and numbers (16 characters)
          # No special characters that cause RDP login issues
          $simplePassword = -join (
              [char[]](65..90)   | Get-Random -Count 6,   # Uppercase A-Z
              [char[]](97..122)  | Get-Random -Count 6,   # Lowercase a-z  
              [char[]](48..57)   | Get-Random -Count 4    # Numbers 0-9
              | Sort-Object { Get-Random }
          )
          
          # Examples of passwords this will generate:
          # "Xk8mL9pR2qA5bN3c" or "T4hF7dK1jM6pQ2n" etc.
          
          $securePass = ConvertTo-SecureString $simplePassword -AsPlainText -Force
          
          # Create user
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          
          # Add to required groups
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          # Enable the account
          Enable-LocalUser -Name "RDP"
          
          # Store credentials
          "RDP_USER=RDP" >> $env:GITHUB_ENV
          "RDP_PASSWORD=$simplePassword" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ User created successfully!"
          Write-Host "üë§ Username: RDP"
          Write-Host "üîë Password: $simplePassword"
          Write-Host "üìù Password contains ONLY letters and numbers - easy to type!"

      - name: Verify User Creation
        run: |
          $user = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          if (-not $user) {
              Write-Error "‚ùå RDP user creation failed!"
              exit 1
          }
          
          Write-Host "‚úÖ User verified: $($user.Name)"
          Write-Host "‚úÖ Account enabled: $($user.Enabled)"
          
          # Verify group membership
          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*\RDP"})
          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*\RDP"})
          
          Write-Host "‚úÖ Is Administrator: $($isAdmin -ne $null)"
          Write-Host "‚úÖ Is RDP User: $($isRDPUser -ne $null)"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Write-Host "üì• Downloading Tailscale..."
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
          
          Write-Host "‚öôÔ∏è Installing Tailscale..."
          Start-Process msiexec.exe -ArgumentList @("/i", "`"$installerPath`"", "/quiet", "/norestart", "/log", "$env:TEMP\tailscale_install.log") -Wait -NoNewWindow
          
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Tailscale installed successfully"

      - name: Start Tailscale Connection
        run: |
          # Wait for Tailscale service to start
          Start-Sleep -Seconds 10
          
          # Start Tailscale
          Write-Host "üîó Starting Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-runner-$env:GITHUB_RUN_ID --accept-routes
          
          # Get Tailscale IP
          $maxRetries = 20
          $retryCount = 0
          $tsIP = $null
          
          while ($retryCount -lt $maxRetries -and -not $tsIP) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if (-not $tsIP) {
                  Write-Host "‚è≥ Waiting for Tailscale IP... ($retryCount/$maxRetries)"
                  Start-Sleep -Seconds 5
                  $retryCount++
              }
          }
          
          if (-not $tsIP) {
              Write-Error "‚ùå Failed to get Tailscale IP after $maxRetries retries"
              exit 1
          }
          
          Write-Host "‚úÖ Tailscale IP: $tsIP"
          "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          
          # Display Tailscale status
          Write-Host "`nüì° Tailscale Status:"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status

      - name: Start RDP Services and Verify
        run: |
          # Restart RDP services
          Write-Host "üîÑ Starting RDP services..."
          Restart-Service -Name TermService -Force
          Restart-Service -Name UmRdpService -Force -ErrorAction SilentlyContinue
          Restart-Service -Name SessionEnv -Force -ErrorAction SilentlyContinue
          
          Start-Sleep -Seconds 10
          
          # Check services are running
          Write-Host "üîç Checking service status..."
          $services = @("TermService", "UmRdpService", "SessionEnv")
          foreach ($service in $services) {
              $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
              if ($svc) {
                  Write-Host "  $service status: $($svc.Status)"
              }
          }
          
          # Verify port 3389 is listening
          Write-Host "üîç Checking port 3389..."
          $listening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
          if (-not $listening) {
              Write-Warning "‚ö†Ô∏è Port 3389 not listening. Checking again..."
              Start-Sleep -Seconds 5
              $listening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
          }
          
          if ($listening) {
              Write-Host "‚úÖ Port 3389 is listening!"
          } else {
              Write-Error "‚ùå Port 3389 is NOT listening"
              Write-Host "üîÑ Trying to manually start RDP..."
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              Restart-Service -Name TermService -Force
              Start-Sleep -Seconds 10
          }

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "‚ïê" * 60
          Write-Host "üöÄ RDP CONNECTION READY - SIMPLE PASSWORD"
          Write-Host "‚ïê" * 60
          Write-Host ""
          Write-Host "üì° Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "üë§ Username: RDP"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "üìã Connection Command:"
          Write-Host "mstsc /v:$env:TAILSCALE_IP"
          Write-Host ""
          Write-Host "‚ú® Password Features:"
          Write-Host "  ‚Ä¢ ONLY letters (A-Z, a-z) and numbers (0-9)"
          Write-Host "  ‚Ä¢ NO special characters like $, >, (, ), etc."
          Write-Host "  ‚Ä¢ Easy to type manually"
          Write-Host ""
          Write-Host "‚ö†Ô∏è  IMPORTANT:"
          Write-Host "1. Install Tailscale on YOUR computer: https://tailscale.com/download"
          Write-Host "2. Sign in with the SAME account as TAILSCALE_AUTH_KEY"
          Write-Host "3. Wait 30 seconds for network sync"
          Write-Host "4. Connect using credentials above"
          Write-Host ""
          Write-Host "‚è≥ This runner will stay active for 60 minutes"
          Write-Host "‚ïê" * 60
          Write-Host ""

      - name: Keep Runner Alive
        run: |
          # Display countdown
          $totalMinutes = 60
          $startTime = Get-Date
          
          for ($minute = 1; $minute -le $totalMinutes; $minute++) {
              $elapsed = (Get-Date) - $startTime
              $remaining = New-TimeSpan -Minutes $totalMinutes -Seconds $elapsed.TotalSeconds
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP Active - Time remaining: $($remaining.ToString('hh\:mm\:ss'))"
              
              # Every 5 minutes, verify RDP is still working
              if ($minute % 5 -eq 0) {
                  $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  $portListening = Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
                  
                  Write-Host "  ‚Ü≥ Status: RDP Service: $($rdpService.Status), Port Listening: $($portListening -ne $null), Tailscale IP: $tsIP"
              }
              
              Start-Sleep -Seconds 60
          }
          
          Write-Host "‚è∞ Time's up! RDP session ending..."
